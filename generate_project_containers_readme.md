# generate\_project\_containers.sh

A pure‑Bash module for deterministic, per‑project container slot management with dead‑slot reuse, concurrent safety, and shared configuration.

---

## Overview

This script turns any filesystem path into a unique “project container” namespace under a common parent folder. It:

* **Slugifies** your project path into a safe folder name.
* **Computes** CRC‑32 hashes to generate one‑to‑one, deterministic suffixes.
* **Creates** or **reuses** container slots when producers (e.g. dev containers) need unique working directories.
* **Manages** a per‑project counter to track how many slots have ever been created.
* **Reclaims** “dead” slots when folders go missing (e.g. failed OAuth flows).
* **Shares** a single `profiles.ini` across all slots via robust symlinks.
* **Handles** concurrent invocations safely using a filesystem lock around counter updates.

This is ideal for development workflows where multiple instances of the same project may run side by side, each requiring its own isolated configuration and token store.

---

## Prerequisites

* **Bash 3.2+** (compatible with macOS and most Linux distros)
* **POSIX tools**:

  * `cksum` (CRC‑32)
  * `xxd` (hex↔binary conversion)
  * Standard utilities: `mkdir`, `rm`, `ps`, `ln`, `sleep`, etc.

No Perl, Python, or other external dependencies are required.

---

## Installation

Simply place `generate_project_containers.sh` in your project’s tooling directory and source or execute it:

```bash
# Make executable
chmod +x generate_project_containers.sh

# In your Docker entrypoint or shell script
source ./generate_project_containers.sh
```

---

## Key Functions

### `generate_container_name <path> <index>`

Computes `<slug>_<8‑hex>` where:

* `<slug>` is the path with `/`→`_` and unsafe characters sanitized.
* `<8‑hex>` is the CRC‑32 of the path, iterated `index` times.

**Usage**:

```bash
generate_container_name "/home/user/project" 2
# → home_user_project_<HEX>
```

### `get_parent_dir <path>`

Returns the parent folder for all slots of a given path:

```bash
echo "$(get_parent_dir "/home/user/project")"
# → demo/home_user_project_<HEX>
```

### `create_container <path>`

Allocates a slot, with logic:

1. **Dead‑slot reuse**: scan existing indices for missing folders → reuse.
2. **New slot**: if none dead, create at next counter index.
3. **Symlink** `profiles.ini` from parent into the slot.
4. **Concurrent safe**: locks counter updates.

Returns the new slot name.

### `determine_next_start_container <path>`

Finds the next slot ready to launch (for diagnostics or orchestration), skipping:

* Missing (“dead”) slots (folder gone).
* Slots with an active lock (`lock` file + live PID).
* Slots with stale locks (PID no longer running).

Returns the slot name or exits with code 1 if none available.

---

## Demo

Running the script directly prints a demonstration:

```bash
./generate_project_containers.sh
```

It will:

1. Create five slots under `demo/<slug>_<HEX>`.
2. Simulate a dead slot removal and reuse it.
3. Recreate `profiles.ini` in the parent and verify all child symlinks.
4. Show which slot would be started next.

---

## Directory Layout

```
demo/
└── home_user_project_<HEX>/           # parent
    ├── .project_container_counter    # counter file
    ├── profiles.ini                  # shared config
    ├── <slot1_name>/                  # slot directories
    │   ├── profiles.ini -> ../profiles.ini
    │   └── lock (optional)
    ├── <slot2_name>/
    │   └── ...
    └── ...
```

---

## Edge Cases & Recommendations

* **Slot‑level locking**: If you expect high concurrency on reuse, consider adding a per‑slot lock to avoid two processes racing to recreate the same “dead” slot.
* **Auth health markers**: To detect OAuth failures beyond missing directories, drop a `.auth_ok` file in each slot after successful login, and treat its absence as “dead.”
* **Heartbeat cleanup**: Containers can `trap 'rm -f <dir>/lock' EXIT` to ensure locks are removed on shutdown.
* **Scalability**: For hundreds of slots, a linear scan may become costly—maintain a small index of available slots under the same lock.

---

## License & Attribution

Feel free to adapt and extend this script for your team’s workflows. No external license restrictions.

---

*Generated by the project container tooling team.*

#!/bin/bash
set -euo pipefail
ENABLE_SUDO=false
DISABLE_FIREWALL=false
SHELL_MODE=false
new_args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --enable-sudo) ENABLE_SUDO=true; shift ;;
        --disable-firewall) DISABLE_FIREWALL=true; shift ;;
        shell) SHELL_MODE=true; shift ;;
        *) new_args+=("$1"); shift ;;
    esac
done
if [[ ${#new_args[@]} -gt 0 ]]; then
    set -- "${new_args[@]}"
else
    set --
fi
export DISABLE_FIREWALL

# Debug output (check environment variable)
if [[ "${VERBOSE:-false}" == "true" ]]; then
    echo "DEBUG: Arguments: $@" >&2
    echo "DEBUG: Number of args: $#" >&2
    echo "DEBUG: ENABLE_SUDO=$ENABLE_SUDO" >&2
    echo "DEBUG: DISABLE_FIREWALL=$DISABLE_FIREWALL" >&2
    echo "DEBUG: SHELL_MODE=$SHELL_MODE" >&2
fi

if [ -f /home/DOCKERUSER/init-firewall ]; then
    /home/DOCKERUSER/init-firewall || true
fi

# Handle sudo access based on --enable-sudo flag
# Note: DOCKERUSER user already has sudoers entry from Dockerfile
if [ "$ENABLE_SUDO" != "true" ]; then
    # Remove sudo access if --enable-sudo wasn't passed
    rm -f /etc/sudoers.d/DOCKERUSER
fi

if [ -n "${CLAUDEBOX_PROJECT_NAME:-}" ]; then
    CONFIG_FILE="/home/DOCKERUSER/.claudebox/profiles.ini"

    if command -v uv >/dev/null 2>&1 && [ -f "$CONFIG_FILE" ] && grep -qE 'python|ml|datascience' "$CONFIG_FILE"; then
        # Python venv already exists at /home/DOCKERUSER/.venv from Docker build
        # Just add activation to shell rc files if needed
        for shell_rc in /home/DOCKERUSER/.zshrc /home/DOCKERUSER/.bashrc; do
            if ! grep -q "source /home/DOCKERUSER/.venv/bin/activate" "$shell_rc"; then
                echo 'if [ -f /home/DOCKERUSER/.venv/bin/activate ]; then source /home/DOCKERUSER/.venv/bin/activate; fi' >> "$shell_rc"
            fi
        done
    fi
fi

cd /home/DOCKERUSER

if [[ "${SHELL_MODE:-false}" == "true" ]]; then
    # Use runuser to avoid PTY signal handling issues
    if [[ "${CLAUDEBOX_WRAP_TMUX:-false}" == "true" ]]; then
        exec runuser -u DOCKERUSER -- bash -c "source /home/DOCKERUSER/.nvm/nvm.sh && cd /workspace && exec tmux new-session /bin/zsh"
    else
        exec runuser -u DOCKERUSER -- bash -c "source /home/DOCKERUSER/.nvm/nvm.sh && cd /workspace && exec /bin/zsh"
    fi
else
    # Claude mode - handle wrapper logic directly here
    if [[ "${1:-}" == "update" ]]; then
        # Special update handling - pass all arguments
        shift  # Remove "update" from arguments
        exec runuser -u DOCKERUSER -- bash -c '
            export NVM_DIR="$HOME/.nvm"
            if [[ -s "$NVM_DIR/nvm.sh" ]]; then
                \. "$NVM_DIR/nvm.sh"
                nvm use default >/dev/null 2>&1 || {
                    echo "Warning: Failed to activate default Node version" >&2
                }
            else
                echo "Warning: NVM not found at $NVM_DIR" >&2
            fi
            
            cd /workspace
            echo "Running update command..."
            
            # Check for stale update lock (older than 5 minutes)
            lock_file="$HOME/.DOCKERUSER/.update.lock"
            if [[ -f "$lock_file" ]]; then
                lock_age=$(( $(date +%s) - $(stat -f %m "$lock_file" 2>/dev/null || stat -c %Y "$lock_file" 2>/dev/null || echo 0) ))
                if [[ $lock_age -gt 300 ]]; then
                    rm -f "$lock_file"
                fi
            fi
            
            # Capture the output of claude update to check if already up to date
            update_output=$(claude update 2>&1)
            echo "$update_output"
            
            # Only run version check if an actual update occurred
            if echo "$update_output" | grep -q "Successfully updated\|Installing update"; then
                echo "Verifying update..."
                claude --version
            fi
        '
    else
        # Regular DOCKERUSER execution
        exec runuser -u DOCKERUSER -- bash -c '
            export NVM_DIR="$HOME/.nvm"
            if [[ -s "$NVM_DIR/nvm.sh" ]]; then
                \. "$NVM_DIR/nvm.sh"
                nvm use default >/dev/null 2>&1 || {
                    echo "Warning: Failed to activate default Node version" >&2
                }
            else
                echo "Warning: NVM not found at $NVM_DIR" >&2
            fi
            
            cd /workspace
            
            # If no arguments and stdin is a terminal, run claude in interactive mode
            if [[ "${CLAUDEBOX_WRAP_TMUX:-false}" == "true" ]]; then
                if [[ $# -eq 0 ]] && [[ -t 0 ]]; then
                    exec tmux new-session claude
                else
                    exec tmux new-session claude "$@"
                fi
            else
                if [[ $# -eq 0 ]] && [[ -t 0 ]]; then
                    exec claude
                else
                    exec claude "$@"
                fi
            fi
        ' -- "$@"
    fi
fi
